<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biomedical Asset QR Scanner</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f5;
  margin: 0;
  padding: 15px;
}

/* LOGO */
.logo {
  text-align: center;
  margin-bottom: 10px;
}
.logo img {
  max-height: 80px;
}

/* HEADINGS */
h2 {
  text-align: center;
  color: #003366;
}

/* SCANNER */
#reader {
  width: 100%;
  max-width: 360px;
  margin: auto;
}

/* CARD */
.card {
  background: #ffffff;
  border-radius: 10px;
  padding: 15px;
  margin-top: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.row {
  margin-bottom: 6px;
}

.label {
  font-weight: bold;
}

.date {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 13px;
  display: inline-block;
}

/* STATUS COLORS */
.ok { background:#d4edda; color:#155724; }
.due { background:#fff3cd; color:#856404; }
.overdue { background:#f8d7da; color:#721c24; }

/* BUTTON */
.btn {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border: none;
  border-radius: 6px;
  background: #0066cc;
  color: white;
  font-size: 15px;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- COMPANY LOGO -->
<div class="logo">
  <img src="logo.jpg" alt="Company Logo">
</div>

<h2>Biomedical Asset QR Scanner</h2>

<div id="reader"></div>
<div id="assetCard" class="card" style="display:none;"></div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// ðŸ”´ GOOGLE SHEET LINK (opensheet)
const SHEET_URL = "https://opensheet.elk.sh/1dULGqA1if8CIroCKIWznYAKujZB9bPr2lCBAhQZmOfY/Sheet2";

const assetCard = document.getElementById("assetCard");

// Open PDF
function openPDF(url) {
  if (!url) {
    alert("PDF not available");
    return;
  }
  window.open(url, "_blank");
}

// Date status logic
function getDateStatus(dateStr) {
  if (!dateStr) return "â€”";

  const today = new Date();
  const parts = dateStr.split("-");
  const due = new Date(parts[2], parts[1]-1, parts[0]);
  const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

  if (diff < 0) return `<span class="date overdue">${dateStr} (Overdue)</span>`;
  if (diff <= 30) return `<span class="date due">${dateStr} (Due Soon)</span>`;
  return `<span class="date ok">${dateStr}</span>`;
}

// Display asset details
function showAsset(a) {
  assetCard.innerHTML = `
    <div class="row"><span class="label">Asset No:</span> ${a.Asset_No}</div>
    <div class="row"><span class="label">Department:</span> ${a.Department}</div>
    <div class="row"><span class="label">Equipment:</span> ${a.Equipment}</div>
    <div class="row"><span class="label">Model:</span> ${a.Model}</div>
    <div class="row"><span class="label">Make:</span> ${a.Make}</div>
    <div class="row"><span class="label">Serial No:</span> ${a.Serial_No}</div>

    <div class="row"><span class="label">Installation Date:</span>
      <span class="date ok">${a.Installation_Date || "â€”"}</span>
    </div>

    <div class="row"><span class="label">PMS Done On:</span>
      <span class="date ok">${a.PMS_Done_On || "â€”"}</span>
    </div>

    <div class="row"><span class="label">PMS Due On:</span>
      ${getDateStatus(a.PMS_Due_On)}
    </div>

    <div class="row"><span class="label">Calibration Done On:</span>
      <span class="date ok">${a.Calibration_Done_On || "â€”"}</span>
    </div>

    <div class="row"><span class="label">Calibration Due On:</span>
      ${getDateStatus(a.Calibration_Due_On)}
    </div>

    <hr>

    <button class="btn" onclick="openPDF('${a.Installation_PDF}')">Installation Report</button>
    <button class="btn" onclick="openPDF('${a.PMS_PDF}')">PMS Report</button>
    <button class="btn" onclick="openPDF('${a.Calibration_PDF}')">Calibration Report</button>
    <button class="btn" onclick="openPDF('${a.Breakdown_PDF}')">Breakdown Report</button>
  `;
  assetCard.style.display = "block";
}

// ðŸ”¥ START SCANNER â€“ FORCE BACK CAMERA
const qr = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(cameras => {
  if (cameras.length === 0) {
    alert("No camera found");
    return;
  }

  const backCamera =
    cameras.find(cam => cam.label.toLowerCase().includes("back")) ||
    cameras[cameras.length - 1];

  qr.start(
    backCamera.id,
    {
      fps: 15,
      qrbox: { width: 280, height: 280 }
    },
    qrText => {
      qr.stop();
      const scannedAsset = qrText.trim();

      fetch(SHEET_URL)
        .then(res => res.json())
        .then(data => {
          const asset = data.find(a => a.Asset_No === scannedAsset);
          if (!asset) {
            alert("Asset not found in Google Sheet");
            return;
          }
          showAsset(asset);
        })
        .catch(() => alert("Unable to fetch data"));
    }
  );
}).catch(() => alert("Camera permission denied"));
</script>

</body>
</html>
